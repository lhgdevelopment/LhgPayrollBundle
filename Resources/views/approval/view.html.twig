{% extends 'base.html.twig' %}
{% import "macros/widgets.html.twig" as widgets %}

{% block page_title %}{{ 'LHG Payroll'|trans }}{% endblock %}

{% block main %}
    {% block content %} 
        <div id="myPayroll" class="mt-4">
            <div class="mt-4">
                <div class="mt-4">  
                    <p class="mt-6" style="margin-tp: 10px;"><strong>Name</strong>: {{ approval.user.alias  }}</p>
                    <p class="mt-6"><strong>Total Hours</strong>: {{ payrollData.total_hours|number_format(3) }} hrs</p>
                    <p><strong>Total Earnings</strong>: ${{ payrollData.total_earnings|number_format(3) }}</p>
                </div>


                <div class="table-responsive mt-4">
                    <table class="table table-bordered">
                        <thead class="thead-dark">
                            <tr>
                                <th>Project</th>
                                <th>Total Duration</th>
                                <th>Total Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for projectId, projectData in projectWiseData %}
                            <tr>
                                <td>{{ projectData.projectName }}</td>
                                <td>{{ projectData.totalDuration|number_format(3) }} hr</td>
                                <td>${{ projectData.totalAmount|number_format(3) }}</td>
                            </tr>
                            <tr>
                                <td colspan="3">
                                    <table class="sub-table table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Total Duration</th>
                                                <th>Total Amount</th>
                                                <th>Begin</th>
                                                <th>End</th>
                                                <th>Description</th> 

                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for date, timesheetData in projectData.timesheetsByDate %}
                                            <tr>
                                                <td>{{ date }}</td>
                                                <td>{{ timesheetData.totalDuration|number_format(3) }} hr</td>
                                                <td>${{ timesheetData.totalAmount|number_format(3) }}</td>
                                            </tr>
                                            {% for timesheet in timesheetData.timesheets %}
                                            <tr>
                                                <td>{{ timesheet.date }}</td>
                                                <td>{{ timesheet.duration_in_hour|number_format(3) }} hr</td>
                                                <td>${{ timesheet.rate|number_format(3) }}</td>
                                                <td>{{ timesheet.begin }}</td>
                                                <td>{{ timesheet.end }}</td>
                                                <td>{{ timesheet.description }}</td> 
                                            </tr>
                                            {% endfor %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {# 1 = pending. team lead to approve / reject #}
                    {% if approval.status == 1 %}
                    <button id="approve_btn" type="button" class="btn btn-success" data-toggle="modal" data-target="#approveModal">
                        Approve
                    </button>

                    <div class="modal fade" id="approveModal" tabindex="-1" role="dialog" aria-labelledby="approveModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="approveModalLabel">Approve Payroll</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">

                                    <label for="message">Note:</label>
                                    <input type="text" id="message" class="form-control"> 
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                    <button type="button" id="approveConfirmBtn" class="btn btn-success">Approve</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# 2 = approved by teamlead and finance to approve / reject #}
                    {% elseif approval.status == 2 %}
                        <!-- Add this button inside the if statement for admins -->
                        <button id="approve_btn" type="button" class="btn btn-success" data-toggle="modal" data-target="#approveModal">
                            Approve
                        </button>

                        <!-- Modal -->
                        <div class="modal fade" id="approveModal" tabindex="-1" role="dialog" aria-labelledby="approveModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="approveModalLabel">Approve Payroll</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body"> 
                                        <label for="commission">Commission:</label>
                                        <input type="number" id="commission" class="form-control"> 

                                        <label for="adjustment">Adjustment:</label>
                                        <input type="number" id="adjustment" class="form-control">

                                        <label for="deduction">Deduction:</label>
                                        <input type="number" id="deduction" class="form-control"> 

                                        <label for="payment_method">Paid Through:</label>
                                        {# <input type="number" id="payment_method" class="form-control">  #}
                                        <select class="form-control">
                                            <option value="Payoneed">Payoneed</option>
                                            <option value="Paypal">Paypal</option>
                                            <option value="Upwork">Upwork</option>
                                        </select>

                                        <label for="message">Note:</label>
                                        <input type="text" id="message" class="form-control"> 
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        <button type="button" id="approveConfirmBtn" class="btn btn-success">Approve</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button id="reject_btn" type="button" class="btn btn-danger">
                            Reject
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>    
    {% endblock %}
{% endblock %}

{% block javascripts %} 
    <script> 
        document.addEventListener("DOMContentLoaded", function() {
            const approveBtn = document.getElementById("approve_btn");
            const modal = document.getElementById("approveModal");
            const totalCommissionInput = document.getElementById("totalCommission");
            // Similarly, get references to other input fields

            // Event listener for the Approve button
            approveBtn.addEventListener("click", function() {
                // Clear input fields when modal is shown
                totalCommissionInput.value = "";
                // Similarly, clear other input fields

                // Event listener for the "Approve" button inside the modal
                document.getElementById("approveConfirmBtn").addEventListener("click", function() {
                    // Get input values
                    const totalCommission = parseFloat(totalCommissionInput.value);
                    // Similarly, get values of other input fields

                    // Calculate updated total using input values
                    const newTotal = calculateNewTotal(totalCommission, /* Add other values */);

                    // Update the UI with the new total
                    document.querySelector(".mt-6 strong").innerText = "Total Earnings: $" + newTotal.toFixed(3);

                    // Close the modal
                    modal.modal("hide");
                });
            });

            // Function to calculate new total based on input values
            function calculateNewTotal(totalCommission, /* Add other parameters */) {
                // Calculate new total using the input values
                // Example calculation: totalEarnings + totalCommission - totalDeduction + totalAdjustment
                return /* Calculated total */;
            }
        });


    </script>

{% endblock %}
